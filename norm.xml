<export><workspace name="norm"><query name="Run denormalisation">xquery version "1.0-ml";

import module namespace n='http://marklogic.com/norm/main' at '/app/models/lib-norm.xqy';
(:
n:generate-denormalisations("/episodes/1234.xml")
:)

n:generate-denormalisations("/odbc/biggie.xml")
</query><query name="unpath">xquery version "1.0-ml";
let $uri := "/episodes/1234.xml"
let $path := "/episode/name"
return xdmp:unpath(fn:concat("fn:doc(""" , $uri , """)", $path))</query><query name="config">xquery version "1.0-ml";
declare namespace n = 'http://marklogic.com/norm/main';

xdmp:document-insert("/admin/config/norm-test.xml",&lt;n:denormalisation&gt;
 &lt;n:name&gt;ODBC Shred&lt;/n:name&gt;
 &lt;n:description&gt;Shred document for ODBC view&lt;/n:description&gt;
 &lt;n:uri-pattern&gt;/prog-avail/##s1:uri##-##auto##-odbc.xml&lt;/n:uri-pattern&gt;
 &lt;n:collections&gt;norm-generated,odbc-data&lt;/n:collections&gt;
 &lt;n:enabled&gt;true&lt;/n:enabled&gt;
 &lt;n:template&gt;
  &lt;n:element name="order"&gt;
   &lt;n:attribute name="id" source="s1" source-path="/order/@id/fn:data()" /&gt;
   
   &lt;n:element name="deliveryaddress" source="s1" source-path="/order/deliveryaddress/text()" /&gt;
   &lt;n:element name="orderitem" source="s1" source-path="/order/orderitem/*"/&gt;
   
   &lt;n:static&gt;
     &lt;madeby&gt;Generated by Adams awesome shredding script&lt;/madeby&gt;
   &lt;/n:static&gt;
  &lt;/n:element&gt;
 &lt;/n:template&gt;
 
 &lt;n:sources&gt;
  &lt;n:source id="s1" name="order" root-xpath="fn:collection(""odbc"")" mode="create-update" required="true" shred="/order/orderitem"&gt;
   &lt;n:collection-match&gt;odbc&lt;/n:collection-match&gt;
   &lt;n:primary-key&gt;&lt;n:element&gt;order&lt;/n:element&gt;&lt;n:attribute&gt;id&lt;/n:attribute&gt;&lt;/n:primary-key&gt;
  &lt;/n:source&gt;
 &lt;/n:sources&gt;
&lt;/n:denormalisation&gt;,
xdmp:default-permissions(),"norm-config"
)

(: NB Shred must ONLY be a path to an element, with at least 1 leading / character :)</query><query name="list indexes">xquery version "1.0-ml";
import module namespace n='http://marklogic.com/norm/main' at '/app/models/lib-norm.xqy';

n:list-indexes-required("/admin/config/norm-test.xml")</query><query name="insert-episode">xquery version "1.0-ml";

xdmp:document-insert("/episodes/1234.xml",
&lt;episode pid="1234"&gt;
 &lt;name&gt;Sailor Down&lt;/name&gt;
 &lt;duration&gt;44&lt;/duration&gt;
&lt;/episode&gt;
,xdmp:default-permissions(),"episodes")</query><query name="delete all denorms">xquery version "1.0-ml";

for $docuri in fn:collection("norm-generated")/fn:base-uri(.)
return xdmp:document-delete($docuri)</query><query name="Query 1">xquery version "1.0-ml";

xdmp:document-insert("/odbc/biggie.xml",
&lt;order id="order1"&gt;
  &lt;deliveryaddress&gt;1 Paddington Way, London&lt;/deliveryaddress&gt;
  &lt;orderitem&gt;
    &lt;code&gt;item1&lt;/code&gt;
    &lt;quantity&gt;50&lt;/quantity&gt;
  &lt;/orderitem&gt;
  &lt;orderitem&gt;
    &lt;code&gt;item2&lt;/code&gt;
    &lt;quantity&gt;4&lt;/quantity&gt;
  &lt;/orderitem&gt;
&lt;/order&gt;
,xdmp:default-permissions(),"odbc")</query></workspace></export>
